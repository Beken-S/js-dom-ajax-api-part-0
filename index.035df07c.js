function e(e,t){let n;return function(...s){null!=n&&clearTimeout(n),n=setTimeout((()=>e(...s)),t)}}function t(e){let t=new AbortController,n=!0;return async function(...s){n||(t.abort(),t=new AbortController),n=!1;try{const r=await e(...s,t.signal);return n=!0,r}catch(e){throw n=!0,e}}}class n extends Error{constructor(e,t){super(t),this.status=e}}const s={BadRequest:400,NotFound:404,InvalidResponse:1e3,NetworkError:1001,TypeError:4e3,UnexpectedError:5e3};async function r(e,t){let r;try{r=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},redirect:"follow",signal:t})}catch(e){return e instanceof DOMException?[null,e]:[null,new n(s.NetworkError,e.message)]}return r.ok?[await r.json(),null]:400===r.status?[null,new n(s.BadRequest,"Некорректный запрос.")]:404===r.status?[null,new n(s.NotFound,"Информация не найдена.")]:[null,new n(s.UnexpectedError,"Что-то пошло не так.")]}const i=new URLSearchParams([["search",""],["limit",10]]);function o(e){return"object"==typeof e&&null!=e}function c(e){return"_embedded"in e}function a(e){return o(e)&&"city:item"in e&&function(e){return o(e)&&"href"in e&&"string"==typeof e.href}(e["city:item"])}function u(e){return o(e)&&"matching_full_name"in e&&"_links"in e&&"string"==typeof e.matching_full_name&&a(e._links)}function l(e){return o(e)&&function(e){return Array.isArray(e)&&e.every(u)}(e["city:search-results"])}function d(e){return o(e)&&"color"in e&&"name"in e&&"score_out_of_10"in e&&"string"==typeof e.color&&"string"==typeof e.name&&"number"==typeof e.score_out_of_10}function m(e){return o(e)&&"categories"in e&&"number"==typeof e.teleport_city_score&&function(e){return Array.isArray(e)&&e.every(d)}(e.categories)}function f(e){return o(e)&&c(e)&&"city:urban_area"in e._embedded&&function(e){return o(e)&&c(e)&&"full_name"in e&&"ua:scores"in e._embedded&&"string"==typeof e.full_name&&m(e._embedded["ua:scores"])}(e._embedded["city:urban_area"])}function g(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function p(e){return function(){e.classList.remove("hidden")}}function h({suggestion:e,link:t}){const n=document.createElement("li");return n.classList.add("history__item"),n.dataset.link=t,n.textContent=e,n}function _({id:e,link:t,suggestion:n},s,r=!1){const i=new RegExp(`(${g(s)})`,"i"),o=document.createElement("li");return o.id=e,o.dataset.suggestion=n,o.dataset.link=t,o.classList.add("search-box__suggestions-item"),o.innerHTML=n.replace(i,'<span class="bold">$1</span>'),r&&o.classList.add("search-box__suggestions-item_visited"),o}function y({name:e,score_out_of_10:t}){const n=document.createElement("li"),s=document.createElement("label"),r=document.createElement("meter"),i=document.createElement("span");return n.classList.add("scores__category"),s.classList.add("scores__label"),r.classList.add("scores__meter"),i.classList.add("scores__score"),s.textContent=`${e}:`,s.setAttribute("for",e),i.textContent=t.toFixed(1),r.id=e,r.setAttribute("max",10),r.setAttribute("low",3),r.setAttribute("high",5),r.setAttribute("optimum",8),r.setAttribute("value",t),n.append(s,r,i),n}function b({name:e,categories:t,totalScore:n}){const s=document.createElement("div"),r=document.createElement("h2"),i=document.createElement("ul"),o=document.createElement("p");return s.classList.add("scores"),r.classList.add("h2"),i.classList.add("scores__list"),o.classList.add("scores__total-score"),r.textContent=e,i.append(function(e){const t=document.createDocumentFragment();return t.append(...e.map(y)),t}(t)),o.textContent=`Total score: ${n.toFixed(1)}`,s.append(r,i,o),s}const v=new class{constructor(e){this.maxLength=e,null==this.get()&&localStorage.setItem("searchHistory",JSON.stringify([]))}get(){return JSON.parse(localStorage.getItem("searchHistory"))}add(e){const t=this.get(),n=t.findIndex((t=>t.id===e.id));n>-1?t.splice(n,1):t.length>this.maxLength&&t.pop(),localStorage.setItem("searchHistory",JSON.stringify([e,...t]))}getRecentSearchQueries(e){return this.get().slice(0,e)}findRecentSearchQueries(e,t){const n=new RegExp(g(e),"i"),s=this.get(),r=[],i=[];if(0===s.length)return[null,null];for(const e of s){if(i.length===t)break;e.suggestion.search(n)>-1&&(r.push(e.id),i.push(e))}return 0===i.length?[null,null]:[r,i]}}(100),w=document.querySelector(".search-box"),E=w.querySelector(".search-box__field"),S=w.querySelector(".search-box__suggestions-list"),L=document.querySelector(".history"),x=document.querySelector(".output"),k=function(e){const t=(n=e,function(){n.classList.add("hidden")});var n;const s=p(e);return function(n,r,i){if(null==n&&null==r||!i)return e.replaceChildren(""),void t();e.replaceChildren(function(e,t,n){const s=document.createDocumentFragment();if(null!=e){const t=e.map((e=>_(e,n,!0)));s.append(...t)}if(null!=t){const e=t.map((e=>_(e,n)));s.append(...e)}return s}(n,r,i)),s()}}(S),C=(R=L,function(e){null!=e?R.replaceChildren(function(e){const t=document.createDocumentFragment();return t.append(...e.map(h)),t}(e)):R.replaceChildren("")});var R;const A=function(e,t){let n=null;return function(s){const r=e.firstElementChild,i=e.lastElementChild;switch(s){case"update":null!=n&&(n.classList.remove(t),n=null);break;case"first":n=r,null!=n&&n.classList.add(t);break;case"next":!function(){if(null==r&&null==i)return;null==n&&(n=r);const e=n?.nextElementSibling;n.classList.remove(t),n=null!=e?e:r,n.classList.add(t)}();break;case"previous":!function(){if(null==r&&null==i)return;null==n&&(n=i);const e=n?.previousElementSibling;n.classList.remove(t),n=null!=e?e:i,n.classList.add(t)}()}return n}}(S,"search-box__suggestions-item_selected");const I=t((async function(e,t){const a=new URL("api/cities","https://api.teleport.org");i.set("search",e),a.search=i.toString();const[u,d]=await r(a.toString(),t);return d?[null,d]:o(m=u)&&c(m)&&l(m._embedded)?0===u.count?[null,null]:[u._embedded["city:search-results"].reduce(((e,t)=>(e.push({id:t._links["city:item"].href.match(/\d+/)[0],link:t._links["city:item"].href,suggestion:t.matching_full_name}),e)),[]),null]:[null,new n(s.InvalidResponse,"Invalid response.")];var m})),N=t((async function(e,t){const o=new URL(e);i.set("embed","city:urban_area/ua:scores"),o.search=i.toString();const[c,a]=await r(o.toString(),t);return a?[null,a]:f(c)?[{name:c._embedded["city:urban_area"].full_name,categories:c._embedded["city:urban_area"]._embedded["ua:scores"].categories,totalScore:c._embedded["city:urban_area"]._embedded["ua:scores"].teleport_city_score},null]:[null,new n(s.NotFound,"There are no statistics for this city.")]})),T=e((async function(e){sessionStorage.setItem("isSubmit",!1);const t=e.target.value;if(!t)return void k();const[n,s]=v.findRecentSearchQueries(t,5);null!=s&&(k(s,null,t),A("update"));const[r,i]=await I(t);if(JSON.parse(sessionStorage.getItem("isSubmit")))return;if(i)return void(i instanceof DOMException||console.error(i));let o;if(null!=r&&null!=s){const e=10-s.length;o=r.filter((e=>!n.includes(e.id))).slice(0,e)}else null!=r&&(o=r);k(s,o,t),A("update")}),200),D=e((async function(e){x.replaceChildren("Loading...");const[t,r]=await N(e.detail);if(r instanceof n&&r.status===s.NotFound)return void x.replaceChildren(r.message);if(r)return void(r instanceof DOMException||console.error(r));x.replaceChildren(b(t))}),200);w.addEventListener("keydown",(function(e){if("ArrowDown"===e.code){const e=A("next");null!=e&&(E.value=e.dataset.suggestion)}if("ArrowUp"===e.code){e.preventDefault();const t=A("previous");null!=t&&(E.value=t.dataset.suggestion)}}),!0),w.addEventListener("submit",(function(e){e.preventDefault(),sessionStorage.setItem("isSubmit",!0);let t=A();if(null==t&&(t=A("first"),null==t))return void(E.value="");const n={id:t.id,link:t.dataset.link,suggestion:t.dataset.suggestion};document.dispatchEvent(new CustomEvent("showScore",{detail:n.link})),v.add(n),E.value="",k(),A("update"),C(v.getRecentSearchQueries(3))}),!0),E.addEventListener("input",T,!0),S.addEventListener("click",(function(e){const t=e.target;if(t instanceof HTMLLIElement){sessionStorage.setItem("isSubmit",!0);const e={id:t.id,link:t.dataset.link,suggestion:t.dataset.suggestion};document.dispatchEvent(new CustomEvent("showScore",{detail:e.link})),v.add(e),E.value="",k(),A("update"),C(v.getRecentSearchQueries(3))}})),L.addEventListener("click",(function(e){e.target instanceof HTMLLIElement&&document.dispatchEvent(new CustomEvent("showScore",{detail:e.target.dataset.link}))})),document.addEventListener("showScore",D,!0),window.addEventListener("storage",(function(e){e.key="searchHistory",C(v.getRecentSearchQueries(3))}),!0),window.onload=function(){E.value="",C(v.getRecentSearchQueries(3))};
//# sourceMappingURL=index.035df07c.js.map
